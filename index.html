<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="color-scheme" content="dark light" />
        <title>Assignment Timer</title>
        <!-- prevent dark-mode flash -->
        <script>
            (function () {
                try {
                    var ls = localStorage.getItem("theme");
                    var prefersDark =
                        window.matchMedia &&
                        window.matchMedia("(prefers-color-scheme: dark)")
                            .matches;
                    var dark = ls === "dark" || (!ls && prefersDark);

                    if (dark) {
                        document.documentElement.classList.add("dark");
                        // Set a matching background immediately to avoid white flash
                        document.documentElement.style.backgroundColor =
                            "#111827";
                    } else {
                        document.documentElement.classList.remove("dark");
                        document.documentElement.style.backgroundColor =
                            "#ffffff";
                    }
                } catch (e) {
                    // If anything goes wrong, fall back to light to avoid a blank screen
                    document.documentElement.style.backgroundColor = "#ffffff";
                }
            })();
        </script>
        <script src="https://cdn.tailwindcss.com"></script>
        <script>
            tailwind.config = {
                darkMode: "class",
                theme: {
                    extend: {
                        colors: {
                            primary: {
                                50: "#f0f5ff",
                                100: "#e0ebff",
                                200: "#c7d9ff",
                                300: "#9fb8ff",
                                400: "#748fff",
                                500: "#4f62ff",
                                600: "#3a3ef7",
                                700: "#2c2de0",
                                800: "#2628b4",
                                900: "#25288e",
                                950: "#18185a",
                            },
                            danger: {
                                50: "#fff1f1",
                                100: "#ffe1e1",
                                200: "#ffc7c7",
                                300: "#ff9e9e",
                                400: "#ff6b6b",
                                500: "#ff3838",
                                600: "#ff1f1f",
                                700: "#e50000",
                                800: "#c50303",
                                900: "#9f0a0a",
                                950: "#560000",
                            },
                        },
                        animation: {
                            "pulse-overtime":
                                "pulse-overtime 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite",
                            "gradient-shift":
                                "gradient-shift 10s ease infinite",
                        },
                        keyframes: {
                            "pulse-overtime": {
                                "0%, 100%": {
                                    opacity: 1,
                                    transform: "scale(1)",
                                },
                                "50%": {
                                    opacity: 0.8,
                                    transform: "scale(1.05)",
                                },
                            },
                            "gradient-shift": {
                                "0%, 100%": {
                                    "background-position": "0% 50%",
                                },
                                "50%": {
                                    "background-position": "100% 50%",
                                },
                            },
                        },
                    },
                },
            };
        </script>
        <style>
            .text-gradient {
                background-image: linear-gradient(
                    to right,
                    var(--tw-gradient-stops)
                );
                --tw-gradient-from: #4f62ff;
                --tw-gradient-to: #2c2de0;
                --tw-gradient-stops: var(--tw-gradient-from),
                    var(--tw-gradient-to);
                -webkit-background-clip: text;
                background-clip: text;
                color: transparent;
            }

            .timer-container {
                display: flex;
                align-items: center;
                justify-content: center;
                height: min(60vh, 400px);
            }

            .overtime {
                color: #ff3838;
                animation: pulse-overtime 1.5s cubic-bezier(0.4, 0, 0.6, 1)
                    infinite;
            }

            .progress-bar {
                height: 1rem;
                background-color: #4f62ff;
                border-radius: 9999px;
                transition-property: all;
                transition-duration: 1000ms;
                transition-timing-function: linear;
            }

            .progress-bar-overtime {
                background-color: #ff3838;
            }

            .timer-display {
                font-family: ui-monospace, SFMono-Regular, Menlo, Monaco,
                    Consolas, "Liberation Mono", "Courier New", monospace;
                font-weight: 800;
                letter-spacing: -0.05em;
                line-height: 1;
                text-align: center;
                text-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            }

            .animate-bg {
                background-image: linear-gradient(
                    to bottom right,
                    #f9fafb,
                    #eff6ff,
                    #f9fafb
                );
                background-size: 200% 200%;
                animation: gradient-shift 10s ease infinite;
            }

            .dark .animate-bg {
                background-image: linear-gradient(
                    to bottom right,
                    #111827,
                    #1f2937,
                    #111827
                );
            }

            /* base colors for safety (prevents any flash if JS toggles colors) */
            body {
                background-color: #f9fafb;
            }
            .dark body {
                background-color: #111827;
            }

            .keyboard-shortcut {
                background-color: #e5e7eb;
                padding: 0.25rem 0.5rem;
                border-radius: 0.25rem;
                font-family: ui-monospace, SFMono-Regular, Menlo, Monaco,
                    Consolas, "Liberation Mono", "Courier New", monospace;
            }

            .dark .keyboard-shortcut {
                background-color: #374151;
            }

            .modal {
                position: fixed;
                inset: 0;
                background-color: rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 50;
                backdrop-filter: blur(4px);
            }

            @keyframes pulse-overtime {
                0%,
                100% {
                    opacity: 1;
                    transform: scale(1);
                }
                50% {
                    opacity: 0.8;
                    transform: scale(1.05);
                }
            }

            @keyframes gradient-shift {
                0%,
                100% {
                    background-position: 0% 50%;
                }
                50% {
                    background-position: 100% 50%;
                }
            }

            .hidden {
                display: none;
            }

            /* Dark mode specific fixes */
            .dark {
                color-scheme: dark;
            }

            html.dark body {
                background-color: #111827;
                color: #f9fafb;
            }
        </style>
    </head>
    <body
        class="animate-bg text-gray-800 h-screen transition-colors duration-300 overflow-hidden"
    >
        <!-- Theme Toggle Button -->
        <button
            id="themeToggle"
            class="fixed top-4 right-4 p-3 rounded-full bg-white/20 backdrop-blur-md dark:bg-black/20 shadow-lg hover:shadow-xl transition-all duration-300 z-40"
        >
            <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-6 w-6 text-gray-700 dark:text-gray-200"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
            >
                <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"
                />
            </svg>
        </button>

        <!-- Setup Section -->
        <div
            id="setupSection"
            class="h-screen flex items-center justify-center"
        >
            <div
                class="max-w-md w-full p-8 bg-white/80 dark:bg-gray-800/80 backdrop-blur-md rounded-2xl shadow-xl"
            >
                <h1 class="text-4xl font-bold text-center mb-8 text-gradient">
                    Assignment Timer
                </h1>

                <div class="space-y-6">
                    <div>
                        <label
                            for="questionCount"
                            class="block text-sm font-medium text-gray-600 dark:text-gray-300 mb-2"
                            >Number of Questions</label
                        >
                        <input
                            type="number"
                            id="questionCount"
                            min="1"
                            value="30"
                            class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary-500 transition-all duration-200"
                        />
                    </div>

                    <div>
                        <label
                            for="timePerQuestion"
                            class="block text-sm font-medium text-gray-600 dark:text-gray-300 mb-2"
                            >Time per Question (seconds)</label
                        >
                        <input
                            type="number"
                            id="timePerQuestion"
                            min="1"
                            value="90"
                            class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary-500 transition-all duration-200"
                        />
                    </div>

                    <button
                        id="startButton"
                        class="w-full mt-6 py-4 bg-primary-500 hover:bg-primary-600 text-white rounded-lg shadow-lg hover:shadow-xl transition-all duration-300 font-medium text-lg flex items-center justify-center"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="h-5 w-5 mr-2"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke="currentColor"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"
                            />
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                            />
                        </svg>
                        Start Timer
                    </button>
                </div>
            </div>
        </div>

        <!-- Timer Section -->
        <div id="timerSection" class="hidden h-screen flex flex-col">
            <div class="h-full flex flex-col justify-between py-4 px-4">
                <div>
                    <!-- Question Progress Indicator -->
                    <div class="flex justify-center mb-2">
                        <div
                            id="questionIndicators"
                            class="flex gap-2 overflow-x-auto py-2 max-w-full"
                        >
                            <!-- Will be populated by JS -->
                        </div>
                    </div>

                    <!-- Question Info -->
                    <div class="text-center mb-2">
                        <h1 class="text-3xl md:text-4xl font-bold">
                            Question
                            <span
                                id="currentQuestion"
                                class="text-primary-500 dark:text-primary-400"
                                >1</span
                            >/<span
                                id="totalQuestions"
                                class="text-gray-600 dark:text-gray-400"
                                >30</span
                            >
                        </h1>
                    </div>

                    <!-- Progress Bar -->
                    <div class="w-full max-w-4xl mx-auto mb-4">
                        <div
                            class="bg-gray-200 dark:bg-gray-700 rounded-full h-4 overflow-hidden"
                        >
                            <div
                                id="progressBar"
                                class="progress-bar w-full"
                            ></div>
                        </div>
                        <div
                            class="flex justify-between text-sm text-gray-600 dark:text-gray-400 mt-1"
                        >
                            <span>Time Elapsed</span>
                            <span id="timeElapsed">0:00</span>
                        </div>
                    </div>
                </div>

                <!-- Timer Display - The main focus, extra large -->
                <div class="timer-container">
                    <div
                        id="timeDisplay"
                        class="timer-display text-[8rem] xs:text-[10rem] sm:text-[12rem] md:text-[16rem] lg:text-[20rem]"
                    >
                        1:30
                    </div>
                </div>

                <div>
                    <!-- Buttons -->
                    <div class="w-full max-w-2xl mx-auto flex gap-4 mb-4">
                        <button
                            id="quitButton"
                            class="flex-none py-4 px-4 bg-white dark:bg-gray-800 text-gray-500 dark:text-gray-400 border-2 border-gray-300 dark:border-gray-600 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 font-medium text-lg flex items-center justify-center"
                        >
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                class="h-5 w-5"
                                fill="none"
                                viewBox="0 0 24 24"
                                stroke="currentColor"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12"
                                />
                            </svg>
                            <span class="sr-only md:not-sr-only md:ml-2"
                                >Quit</span
                            >
                        </button>
                        <button
                            id="pauseButton"
                            class="flex-1 py-4 px-6 bg-white dark:bg-gray-800 text-primary-500 dark:text-primary-400 border-2 border-primary-500 dark:border-primary-400 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 font-medium text-lg flex items-center justify-center"
                        >
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                class="h-5 w-5 mr-2"
                                fill="none"
                                viewBox="0 0 24 24"
                                stroke="currentColor"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"
                                />
                            </svg>
                            Pause
                        </button>
                        <button
                            id="nextButton"
                            class="flex-1 py-4 px-6 bg-primary-500 hover:bg-primary-600 text-white rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 font-medium text-lg flex items-center justify-center"
                        >
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                class="h-5 w-5 mr-2"
                                fill="none"
                                viewBox="0 0 24 24"
                                stroke="currentColor"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M13 5l7 7-7 7M5 5l7 7-7 7"
                                />
                            </svg>
                            Next Question
                        </button>
                    </div>

                    <!-- Keyboard Shortcuts -->
                    <div
                        class="text-center text-gray-600 dark:text-gray-400 text-sm md:text-base py-3"
                    >
                        Press
                        <span class="keyboard-shortcut">Space</span>
                        for next question •
                        <span class="keyboard-shortcut">P</span>
                        to pause/resume •
                        <span class="keyboard-shortcut">Q</span>
                        to quit
                    </div>
                </div>
            </div>
        </div>

        <!-- Summary Section -->
        <div
            id="summarySection"
            class="hidden h-screen flex items-center justify-center overflow-hidden"
        >
            <div
                class="w-full max-w-3xl mx-auto px-4 py-4 h-full flex items-center"
            >
                <div
                    class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-md rounded-2xl shadow-xl p-6 md:p-8 w-full flex flex-col max-h-[90vh]"
                >
                    <h1
                        class="text-3xl md:text-4xl font-bold text-center mb-4 md:mb-8 text-gradient"
                    >
                        Summary
                    </h1>

                    <div
                        class="space-y-4 md:space-y-6 flex-1 flex flex-col overflow-hidden"
                    >
                        <div
                            class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6"
                        >
                            <div
                                class="bg-gray-100 dark:bg-gray-700 p-4 md:p-6 rounded-xl"
                            >
                                <div
                                    class="text-base md:text-lg text-gray-600 dark:text-gray-400"
                                >
                                    Total Time
                                </div>
                                <div
                                    id="totalTime"
                                    class="text-2xl md:text-3xl font-bold"
                                >
                                    0:00
                                </div>
                            </div>
                            <div
                                class="bg-gray-100 dark:bg-gray-700 p-4 md:p-6 rounded-xl"
                            >
                                <div
                                    class="text-base md:text-lg text-gray-600 dark:text-gray-400"
                                >
                                    Average Time
                                </div>
                                <div
                                    id="averageTime"
                                    class="text-2xl md:text-3xl font-bold"
                                >
                                    0:00
                                </div>
                            </div>
                            <div
                                class="bg-gray-100 dark:bg-gray-700 p-4 md:p-6 rounded-xl"
                            >
                                <div
                                    class="text-base md:text-lg text-gray-600 dark:text-gray-400"
                                >
                                    Overtime Questions
                                </div>
                                <div
                                    id="overtimeCount"
                                    class="text-2xl md:text-3xl font-bold"
                                >
                                    0
                                </div>
                            </div>
                        </div>

                        <div
                            class="flex-1 flex flex-col min-h-0 overflow-hidden"
                        >
                            <h2
                                class="text-xl font-semibold mb-2 md:mb-4 text-gray-700 dark:text-gray-300"
                            >
                                Question Breakdown
                            </h2>
                            <div
                                id="questionList"
                                class="space-y-2 overflow-y-auto pr-2 flex-1 max-h-[30vh] md:max-h-[40vh] pb-2"
                            >
                                <!-- Question list will be generated here -->
                            </div>
                        </div>

                        <div class="flex gap-4">
                            <button
                                id="exportButton"
                                class="py-3 md:py-4 px-6 bg-white dark:bg-gray-800 text-primary-500 dark:text-primary-400 border-2 border-primary-500 dark:border-primary-400 rounded-lg shadow-lg hover:shadow-xl transition-all duration-300 font-medium text-lg flex items-center justify-center"
                            >
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    class="h-5 w-5 mr-2"
                                    fill="none"
                                    viewBox="0 0 24 24"
                                    stroke="currentColor"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"
                                    />
                                </svg>
                                Export Results
                            </button>
                            <button
                                id="restartButton"
                                class="flex-1 py-3 md:py-4 bg-primary-500 hover:bg-primary-600 text-white rounded-lg shadow-lg hover:shadow-xl transition-all duration-300 font-medium text-lg flex items-center justify-center"
                            >
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    class="h-5 w-5 mr-2"
                                    fill="none"
                                    viewBox="0 0 24 24"
                                    stroke="currentColor"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                                    />
                                </svg>
                                Start New Session
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quit Confirmation Modal -->
        <div
            id="quitModal"
            class="modal hidden"
            role="dialog"
            aria-modal="true"
            aria-hidden="true"
        >
            <div
                class="bg-white dark:bg-gray-800 rounded-xl p-6 max-w-md w-full mx-4 shadow-2xl"
                tabindex="-1"
            >
                <h3 class="text-xl font-bold mb-4">Quit Paper?</h3>
                <p class="mb-6 text-gray-600 dark:text-gray-300">
                    Are you sure you want to quit? Your progress will not be
                    saved.
                </p>
                <div class="flex gap-4">
                    <button
                        id="quitCancelButton"
                        class="flex-1 py-3 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-lg transition-colors duration-200"
                    >
                        Cancel
                    </button>
                    <button
                        id="quitConfirmButton"
                        class="flex-1 py-3 bg-danger-500 hover:bg-danger-600 text-white rounded-lg transition-colors duration-200"
                    >
                        Quit Paper
                    </button>
                </div>
            </div>
        </div>

        <!-- Export Name Modal -->
        <div id="exportModal" class="modal hidden">
            <div
                class="bg-white dark:bg-gray-800 rounded-xl p-6 max-w-md w-full mx-4 shadow-2xl"
            >
                <h3 class="text-xl font-bold mb-4">Export Results</h3>
                <p class="mb-4 text-gray-600 dark:text-gray-300">
                    Enter a name for your worksheet:
                </p>
                <input
                    type="text"
                    id="worksheetName"
                    placeholder="e.g. Math Practice Paper 1"
                    class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary-500 transition-all duration-200 mb-6"
                />
                <div class="flex gap-4">
                    <button
                        id="exportCancelButton"
                        class="flex-1 py-3 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-lg transition-colors duration-200"
                    >
                        Cancel
                    </button>
                    <button
                        id="exportConfirmButton"
                        class="flex-1 py-3 bg-primary-500 hover:bg-primary-600 text-white rounded-lg transition-colors duration-200"
                    >
                        Download
                    </button>
                </div>
            </div>
        </div>

        <!-- Toast -->
        <div
            id="toast"
            class="pointer-events-none fixed inset-x-0 top-4 mx-auto w-fit max-w-[90vw] rounded-xl bg-black/80 text-white text-sm md:text-base px-4 py-2 shadow-xl opacity-0 translate-y-[-8px] transition-all duration-300 z-[60]"
        >
            Resume the timer before going to the next question.
        </div>

        <script>
            // DOM Elements
            const setupSection = document.getElementById("setupSection");
            const timerSection = document.getElementById("timerSection");
            const summarySection = document.getElementById("summarySection");
            const startButton = document.getElementById("startButton");
            const pauseButton = document.getElementById("pauseButton");
            const nextButton = document.getElementById("nextButton");
            const quitButton = document.getElementById("quitButton");
            const restartButton = document.getElementById("restartButton");
            const exportButton = document.getElementById("exportButton");
            const timeDisplay = document.getElementById("timeDisplay");
            const progressBar = document.getElementById("progressBar");
            const currentQuestionEl =
                document.getElementById("currentQuestion");
            const totalQuestionsEl = document.getElementById("totalQuestions");
            const timeElapsedEl = document.getElementById("timeElapsed");
            const totalTimeEl = document.getElementById("totalTime");
            const averageTimeEl = document.getElementById("averageTime");
            const overtimeCountEl = document.getElementById("overtimeCount");
            const questionListEl = document.getElementById("questionList");
            const themeToggle = document.getElementById("themeToggle");
            const questionIndicators =
                document.getElementById("questionIndicators");
            const quitModal = document.getElementById("quitModal");
            const quitCancelButton =
                document.getElementById("quitCancelButton");
            const quitConfirmButton =
                document.getElementById("quitConfirmButton");
            const exportModal = document.getElementById("exportModal");
            const worksheetNameInput = document.getElementById("worksheetName");
            const exportCancelButton =
                document.getElementById("exportCancelButton");
            const exportConfirmButton = document.getElementById(
                "exportConfirmButton"
            );

            // Timer State
            let timer;
            let timerState = {
                questionCount: 10,
                timePerQuestion: 90, // seconds
                currentQuestion: 1,
                timeRemaining: 90,
                originalTime: 90,
                isPaused: false,
                isOvertime: false,
                questionTimes: [],
                startTime: 0,
            };

            // Initialize theme from localStorage
            function initTheme() {
                const isDark =
                    document.documentElement.classList.contains("dark");
                themeToggle.innerHTML = isDark
                    ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-200" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/></svg>`
                    : `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/></svg>`;
            }

            // Toggle theme between light and dark
            function toggleTheme() {
                const isDark =
                    document.documentElement.classList.toggle("dark");
                localStorage.setItem("theme", isDark ? "dark" : "light");

                // Update icon
                themeToggle.innerHTML = isDark
                    ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-200" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
        </svg>`
                    : `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
        </svg>`;
            }

            // Format time from seconds to MM:SS
            function formatTime(seconds) {
                const mins = Math.floor(Math.abs(seconds) / 60);
                const secs = Math.abs(seconds) % 60;
                const prefix = seconds < 0 ? "+" : ""; // Add plus sign for overtime
                return `${prefix}${mins}:${secs.toString().padStart(2, "0")}`;
            }

            // Create question indicators
            function createQuestionIndicators() {
                questionIndicators.innerHTML = "";
                for (let i = 1; i <= timerState.questionCount; i++) {
                    const indicator = document.createElement("div");
                    indicator.className =
                        i === timerState.currentQuestion
                            ? "w-3 h-3 rounded-full bg-primary-500"
                            : "w-3 h-3 rounded-full bg-gray-300 dark:bg-gray-600";
                    indicator.setAttribute("data-question", i);
                    questionIndicators.appendChild(indicator);
                }
            }

            // Update question indicators
            function updateQuestionIndicators() {
                const indicators = questionIndicators.querySelectorAll("div");
                indicators.forEach((indicator) => {
                    const questionNum = parseInt(
                        indicator.getAttribute("data-question")
                    );
                    if (questionNum === timerState.currentQuestion) {
                        indicator.className =
                            "w-3 h-3 rounded-full bg-primary-500";
                    } else if (questionNum < timerState.currentQuestion) {
                        indicator.className =
                            "w-3 h-3 rounded-full bg-gray-400 dark:bg-gray-500";
                    } else {
                        indicator.className =
                            "w-3 h-3 rounded-full bg-gray-300 dark:bg-gray-600";
                    }
                });
            }

            // Update Next Button Text based on question number
            function updateNextButtonText() {
                if (timerState.currentQuestion === timerState.questionCount) {
                    nextButton.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                        Finish Paper
                    `;
                } else {
                    nextButton.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7" />
                        </svg>
                        Next Question
                    `;
                }
            }

            // Update timer display
            function updateTimerDisplay() {
                // Update the time display
                timeDisplay.textContent = formatTime(timerState.timeRemaining);

                // Update progress bar
                const progressPercentage =
                    (timerState.timeRemaining / timerState.originalTime) * 100;
                progressBar.style.width = `${Math.min(
                    100,
                    progressPercentage
                )}%`;

                // Handle overtime styling
                if (timerState.timeRemaining <= 0 && !timerState.isOvertime) {
                    timerState.isOvertime = true;
                    timeDisplay.classList.add("overtime");
                    progressBar.classList.add("progress-bar-overtime");
                }

                // Update time elapsed (showing positive value even in overtime)
                const elapsed =
                    timerState.originalTime - timerState.timeRemaining;
                timeElapsedEl.textContent = formatTime(elapsed);

                // Update question counter
                currentQuestionEl.textContent = timerState.currentQuestion;
                totalQuestionsEl.textContent = timerState.questionCount;

                // Update question indicators
                updateQuestionIndicators();

                // Update next button text
                updateNextButtonText();
            }

            // Start timer countdown
            let tick_anchor = null;

            function startTimer() {
                if (timerState.isPaused) return;
                clearInterval(timer);
                tick_anchor = Date.now();
                timer = setInterval(() => {
                    const elapsed = Math.floor(
                        (Date.now() - tick_anchor) / 1000
                    );
                    timerState.timeRemaining =
                        timerState.originalTime - elapsed;
                    updateTimerDisplay();
                }, 250);
            }

            // Pause the timer
            function pauseTimer() {
                nextButton.disabled = true;
                nextButton.classList.add("opacity-60", "cursor-not-allowed");
                clearInterval(timer);
                timerState.isPaused = true;
                pauseButton.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                Resume
            `;
            }

            // Resume the timer
            function resumeTimer() {
                nextButton.disabled = false;
                nextButton.classList.remove("opacity-60", "cursor-not-allowed");
                timerState.isPaused = false;
                pauseButton.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                Pause
            `;
                startTimer();
            }

            // Toast
            function showToast(
                msg = "Resume the timer before going to the next question."
            ) {
                const t = document.getElementById("toast");
                t.textContent = msg;
                // show
                t.classList.remove("opacity-0");
                t.classList.remove("translate-y-[-8px]");
                // hide after 2s
                clearTimeout(showToast._tid);
                showToast._tid = setTimeout(() => {
                    t.classList.add("opacity-0");
                    t.classList.add("translate-y-[-8px]");
                }, 2000);
            }

            // All background roots that should be untabbable when a modal is open
            const focus_roots = [
                setupSection,
                timerSection,
                summarySection,
                themeToggle,
            ];

            function setModalState(modalEl, isOpen) {
                // Hide/show from AT and set inert to block focus/tabbing
                focus_roots.forEach((el) => {
                    if (!el) return;
                    if (isOpen) {
                        el.setAttribute("inert", "");
                        el.setAttribute("aria-hidden", "true");
                    } else {
                        el.removeAttribute("inert");
                        el.removeAttribute("aria-hidden");
                    }
                });

                // modal visibility + aria
                modalEl.classList.toggle("hidden", !isOpen);
                modalEl.setAttribute("aria-hidden", isOpen ? "false" : "true");

                if (isOpen) {
                    // Focus the first focusable in the modal
                    const content = modalEl.querySelector(
                        '[tabindex], button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
                    );
                    (content || modalEl).focus();
                }
            }

            // Prevent modal focus leak (pressing tab)
            function trapFocus(modal) {
                // Prevent multiple listeners if called more than once
                if (modal._trapBound) return;
                modal._trapBound = true;

                modal.addEventListener("keydown", (e) => {
                    if (e.key !== "Tab") return;

                    const focusables = modal.querySelectorAll(
                        'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
                    );
                    if (!focusables.length) return;

                    const first = focusables[0];
                    const last = focusables[focusables.length - 1];

                    if (e.shiftKey && document.activeElement === first) {
                        e.preventDefault();
                        last.focus();
                    } else if (!e.shiftKey && document.activeElement === last) {
                        e.preventDefault();
                        first.focus();
                    }
                });
            }
            // Move to the next question
            function nextQuestion() {
                const timeTaken =
                    timerState.originalTime - timerState.timeRemaining;
                timerState.questionTimes.push({
                    question: timerState.currentQuestion,
                    time: timeTaken,
                    isOvertime: timerState.isOvertime,
                });

                if (timerState.currentQuestion >= timerState.questionCount) {
                    showSummary();
                    return;
                }

                clearInterval(timer);
                timerState.currentQuestion++;
                timerState.timeRemaining = timerState.originalTime;
                timerState.isOvertime = false;

                timeDisplay.classList.remove("overtime");
                progressBar.classList.remove("progress-bar-overtime");

                updateTimerDisplay();
                timerState.isPaused = false; // we only ever allow Next when not paused
                pauseButton.innerHTML = `...Pause SVG... Pause`;
                startTimer();
            }

            // Quit modal
            function showQuitModal() {
                trapFocus(quitModal);
                setModalState(quitModal, true);
            }
            function hideQuitModal() {
                setModalState(quitModal, false);
            }

            // Confirm quit and return to setup screen
            function confirmQuit() {
                location.reload();
            }

            // Show summary after all questions
            function showSummary() {
                clearInterval(timer);
                timerSection.classList.add("hidden");
                summarySection.classList.remove("hidden");

                // Calculate stats
                const totalSeconds = timerState.questionTimes.reduce(
                    (sum, q) => sum + q.time,
                    0
                );
                const averageSeconds = Math.round(
                    totalSeconds / timerState.questionCount
                );
                const overtimeCount = timerState.questionTimes.filter(
                    (q) => q.isOvertime
                ).length;

                // Update summary display
                totalTimeEl.textContent = formatTime(totalSeconds);
                averageTimeEl.textContent = formatTime(averageSeconds);
                overtimeCountEl.textContent = overtimeCount;

                // Generate question list
                questionListEl.innerHTML = "";
                timerState.questionTimes.forEach((q) => {
                    const questionItem = document.createElement("div");
                    questionItem.className =
                        "flex justify-between p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg";

                    const questionNumber = document.createElement("span");
                    questionNumber.textContent = `Question ${q.question}`;

                    const questionTime = document.createElement("span");
                    questionTime.textContent = formatTime(q.time);
                    if (q.isOvertime) {
                        questionTime.className = "text-danger-500 font-medium";
                    }

                    questionItem.appendChild(questionNumber);
                    questionItem.appendChild(questionTime);
                    questionListEl.appendChild(questionItem);
                });
            }

            // Show export modal
            function showExportModal() {
                exportModal.classList.remove("hidden");
                worksheetNameInput.focus();
            }

            // Hide export modal
            function hideExportModal() {
                exportModal.classList.add("hidden");
            }

            // Generate and download text file with results
            function exportResults() {
                if (!worksheetNameInput.value.trim()) {
                    showToast("Enter a worksheet name");
                    worksheetNameInput.focus();
                    return;
                }

                const worksheetName =
                    worksheetNameInput.value.trim() || "Assignment Results";
                const fileName = `${worksheetName}.txt`;

                // Calculate stats
                const totalSeconds = timerState.questionTimes.reduce(
                    (sum, q) => sum + q.time,
                    0
                );
                const averageSeconds = Math.round(
                    totalSeconds / timerState.questionCount
                );
                const overtimeCount = timerState.questionTimes.filter(
                    (q) => q.isOvertime
                ).length;

                // Format date
                const date = new Date();
                const dateString = date.toLocaleDateString();
                const timeString = date.toLocaleTimeString();

                // Create content
                let content = `${worksheetName}\n`;
                content += `Date: ${dateString} ${timeString}\n\n`;
                content += `Total Questions: ${timerState.questionCount}\n`;
                content += `Time Per Question: ${formatTime(
                    timerState.originalTime
                )}\n`;
                content += `Total Time: ${formatTime(totalSeconds)}\n`;
                content += `Average Time: ${formatTime(averageSeconds)}\n`;
                content += `Overtime Questions: ${overtimeCount}\n\n`;
                content += `Question Breakdown:\n`;

                timerState.questionTimes.forEach((q) => {
                    content += `Question ${q.question}: ${formatTime(q.time)}${
                        q.isOvertime ? " (overtime)" : ""
                    }\n`;
                });

                // Create and download file
                const blob = new Blob([content], { type: "text/plain" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                hideExportModal();
            }

            // Start a new session
            function startNewSession() {
                // Get values from input
                const questionCount =
                    parseInt(document.getElementById("questionCount").value) ||
                    10;
                const timePerQuestion =
                    parseInt(
                        document.getElementById("timePerQuestion").value
                    ) || 90;

                // Initialize timer state
                timerState = {
                    questionCount,
                    timePerQuestion,
                    currentQuestion: 1,
                    timeRemaining: timePerQuestion,
                    originalTime: timePerQuestion,
                    isPaused: false,
                    isOvertime: false,
                    questionTimes: [],
                    startTime: Date.now(),
                };

                // Create question indicators
                createQuestionIndicators();

                // Update display
                updateTimerDisplay();

                // Show timer section
                setupSection.classList.add("hidden");
                summarySection.classList.add("hidden");
                timerSection.classList.remove("hidden");

                // Start the timer
                startTimer();
            }

            // Event Listeners
            startButton.addEventListener("click", startNewSession);

            pauseButton.addEventListener("click", () => {
                if (timerState.isPaused) {
                    resumeTimer();
                } else {
                    pauseTimer();
                }
            });

            function renderPauseButton() {
                pauseButton.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6M5 3h14a2 2 0 012 2v14a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2z" />
                    </svg>
                    Pause
                `;
                            }

                            function renderResumeButton() {
                                pauseButton.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    Resume
                `;
            }

            function setPauseUI(isPaused) {
                if (isPaused) renderResumeButton();
                else renderPauseButton();
            }

            nextButton.addEventListener("click", () => {
                if (timerState.isPaused) {
                    showToast();
                    return;
                }
                nextQuestion();
            });

            quitButton.addEventListener("click", showQuitModal);
            quitCancelButton.addEventListener("click", hideQuitModal);
            quitConfirmButton.addEventListener("click", confirmQuit);

            restartButton.addEventListener("click", () => {
                timerSection.classList.add("hidden");
                summarySection.classList.add("hidden");
                setupSection.classList.remove("hidden");
            });

            exportButton.addEventListener("click", showExportModal);
            exportCancelButton.addEventListener("click", hideExportModal);
            exportConfirmButton.addEventListener("click", exportResults);

            themeToggle.addEventListener("click", toggleTheme);

            // Keyboard shortcuts
            document.addEventListener("keydown", (e) => {
                if (!timerSection.classList.contains("hidden")) {
                    if (e.code === "Space") {
                        e.preventDefault(); // Prevent page scrolling
                        if (timerState.isPaused) {
                            showToast();
                            return;
                        }
                        nextQuestion();
                    } else if (e.key.toLowerCase() === "p") {
                        if (timerState.isPaused) {
                            resumeTimer();
                        } else {
                            pauseTimer();
                        }
                    } else if (e.key.toLowerCase() === "q") {
                        showQuitModal();
                    }
                }

                // Allow Escape key to close modals
                if (e.key === "Escape") {
                    if (!quitModal.classList.contains("hidden")) {
                        hideQuitModal();
                    } else if (!exportModal.classList.contains("hidden")) {
                        hideExportModal();
                    }
                }

                // Enter key in export modal to confirm
                if (
                    e.key === "Enter" &&
                    !exportModal.classList.contains("hidden")
                ) {
                    exportResults();
                }
            });

            // Initialize theme on load
            document.addEventListener("DOMContentLoaded", initTheme);
        </script>
    </body>
</html>
